define(["jquery","pubsub"],function(e,t){var n=[],r,i=function(e,n,i){r=i;for(var s=0;s<n;s++){t.publish("map_model:row_start",s),this.map[s]=[];for(var o=0;o<e;o++)t.publish("map_model:column_start",{x:o,y:s}),this.map[s][o]={tile_name:r};t.publish("map_model:row_end",s)}t.publish("map_model:build_end")},s=function(){for(var e=0;e<n.length;e++)for(var t=0;t<n[e].length;t++)u(t,e,r)},o=function(){t.publish("map_model:refresh_start");for(var e=0;e<n.length;e++)for(var r=0;r<n[e].length;r++)t.publish("map_model:refresh_tile",{x:r,y:e,tile_name:n[e][r].tile_name});t.publish("map_model:refresh_end")},u=function(e,r,i){if(!n[r]||!n[r][e])return;t.publish("map_model:set_tile_start",{x:e,y:r,tile_name:n[r][e].tile_name}),n[r][e].tile_name=i,t.publish("map_model:set_tile_end",{x:e,y:r,tile_name:i})},a=function(t){if(t=="")return;try{var n=e.parseJSON(t)}catch(r){return}s();for(var i=0;i<n.map.length;i++){var o=n.map[i].x,a=n.map[i].y,f=n.map[i].tile;u(o,a,f)}};return{map:n,build:i,setTile:u,loadJson:a,refreshMap:o}});